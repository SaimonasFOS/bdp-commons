pipeline {
	agent any

	environment {
		ROOTFOLDER = 'data-collectors/airquality-appabz'
		KEYFILE = credentials('bdp-airquality-datacollector-appabz-sftp-key-testserver')
		HOSTS = credentials('bdp-airquality-datacollector-appabz-sftp-knownhosts')
		SSHFOLDER = "$ROOTFOLDER/src/main/resources/META-INF/.ssh"
		PASS = credentials('bdp-airquality-datacollector-appabz-sftp-passphrase-testserver')
		TESTSERVER_TOMCAT_ENDPOINT = credentials('testserver-tomcat8-url')
	}

	stages {
		stage('Configure') {
			steps {
				// Defined in log4j2.properties and application.properties, change this on servers directly!
				sh 'test -w /var/log/opendatahub/data-collectors/'

				// Check if the ssh folder exists, create one if not and put needed files with correct permissions
				sh '''
					mkdir -p "${SSHFOLDER}"
					rm -f "${SSHFOLDER}/id_rsa_sftp" "${SSHFOLDER}/known_hosts"
					cp "${KEYFILE}" "${SSHFOLDER}/id_rsa_sftp"
					cp "${HOSTS}" "${SSHFOLDER}/known_hosts"
					chmod 400 "${SSHFOLDER}/id_rsa_sftp"
					chmod 644 "${SSHFOLDER}/known_hosts"
					'''

				/*
				 * Configure application.properties and inject the correct pass-phrase for the test server.
				 * Security: set +x turns echoing off (otherwise password would be printed to logs)
				 */
				sh '''
					set +x
					export PASSX="$(echo ${PASS} | sed -e "s/[\\\\/&]/\\\\\\\\&/g")"
					sed -ie '/ftp\\.pass=/ s/=.*/='$PASSX'/' $ROOTFOLDER/src/main/resources/META-INF/spring/application.properties
					set -x
					'''
			}
		}
		stage('Test') {
			steps {
				sh 'cd $ROOTFOLDER && mvn clean integration-test'
			}
		}
		stage('Deploy') {
            steps {
                sh 'cd $ROOTFOLDER && mvn tomcat:redeploy -Dmaven.test.skip=true -Dmaven.tomcat.url=${TESTSERVER_TOMCAT_ENDPOINT} -Dmaven.tomcat.server=testServer'
            }
        }
	}
}
